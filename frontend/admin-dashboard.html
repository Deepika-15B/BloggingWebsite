<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard - BlogVerse</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #eef3f9;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
    }
    .sidebar {
      width: 220px;
      min-height: 100vh;
      background: #1f2a44;
      color: #f0f3f9;
      position: fixed;
      padding: 1rem 0;
    }
    .sidebar a {
      color: #cfd8e7;
      text-decoration: none;
      display: block;
      padding: .75rem 1.25rem;
      margin: 4px 0;
      border-radius: 6px;
    }
    .sidebar a.active, .sidebar a:hover {
      background: #2f3f6f;
      color: white;
    }
    .main {
      margin-left: 240px;
      padding: 30px;
    }
    .card-summary {
      border-radius: 12px;
      overflow: hidden;
    }
    .table-wrapper {
      margin-top: 1rem;
    }
    .badge-role {
      background: #20c997;
    }
  </style>
</head>
<body>

  <div class="d-flex">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="text-center mb-4">
        <h4 class="mb-0">Admin Panel</h4>
        <small>BlogVerse</small>
      </div>
      <a href="#" class="active">Overview</a>
      <a href="#" onclick="showSection('users')">Users</a>
      <a href="#" onclick="showSection('posts')">Posts</a>
      <a href="#" onclick="logout()">Logout</a>
    </div>

    <!-- Main content -->
    <div class="main flex-grow-1">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2>Welcome, Admin</h2>
          <p class="text-muted">Overview of platform activity</p>
        </div>
      </div>

      <!-- Summary cards -->
      <div class="row g-3">
        <div class="col-md-4">
          <div class="card card-summary p-3">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="text-uppercase">Total Users</h6>
                <h3 id="adminTotalUsers">0</h3>
              </div>
              <div class="fs-2">üë•</div>
            </div>
            <small class="text-muted">Registered on platform</small>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card card-summary p-3">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="text-uppercase">Total Posts</h6>
                <h3 id="adminTotalPosts">0</h3>
              </div>
              <div class="fs-2">‚úçÔ∏è</div>
            </div>
            <small class="text-muted">All posts by users</small>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card card-summary p-3">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="text-uppercase">Flagged / Pending</h6>
                <h3 id="adminFlagged">0</h3>
              </div>
              <div class="fs-2">‚ö†Ô∏è</div>
            </div>
            <small class="text-muted">Needs review</small>
          </div>
        </div>
      </div>

      <!-- Users Section -->
      <div id="usersSection" class="table-wrapper mt-5">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h4>Users</h4>
          <input type="text" id="userSearch" placeholder="Search users..." class="form-control form-control-sm w-25" oninput="loadUsers()">
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Username / Email</th>
                <th>Role</th>
                <th>Joined</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <!-- populated -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Posts Section -->
      <div id="postsSection" class="table-wrapper mt-5" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h4>Posts</h4>
          <input type="text" id="postSearch" placeholder="Search posts..." class="form-control form-control-sm w-25" oninput="loadPosts()">
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Title</th>
                <th>Author</th>
                <th>Status</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="postsTableBody">
              <!-- populated -->
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
   

    function showSection(section) {
      document.getElementById('usersSection').style.display = section === 'users' ? 'block' : 'none';
      document.getElementById('postsSection').style.display = section === 'posts' ? 'block' : 'none';
    }

    async function loadSummary() {
      const token = localStorage.getItem('adminToken');
      const res = await fetch("http://localhost:5000/api/admin/manage/summary", {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) return;
      const data = await res.json();
      document.getElementById('adminTotalUsers').textContent = data.usersCount || 0;
      document.getElementById('adminTotalPosts').textContent = data.postsCount || 0;
      document.getElementById('adminFlagged').textContent = data.flagged || 0;
    }

    async function loadUsers() {
      const token = localStorage.getItem('adminToken');
      const res = await fetch("http://localhost:5000/api/admin/manage/users", {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) return;
      const users = await res.json();
      const filter = document.getElementById('userSearch').value.toLowerCase();
      const filtered = users.filter(u => (u.username||'').toLowerCase().includes(filter) || (u.email||'').toLowerCase().includes(filter));

      const tbody = document.getElementById('usersTableBody');
      tbody.innerHTML = "";
      filtered.forEach((u, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${u.username} <br><small>${u.email}</small></td>
          <td><span class="badge bg-info">${u.role}</span></td>
          <td>${u.createdAt}</td>
          <td>
            <button class="btn btn-sm btn-danger" onclick="deleteUser('${u._id}')">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function loadPosts() {
      const token = localStorage.getItem('adminToken');
      const res = await fetch("http://localhost:5000/api/admin/manage/posts", {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) return;
      const posts = await res.json();
      const filter = document.getElementById('postSearch').value.toLowerCase();
      const filtered = posts.filter(p => (p.title||'').toLowerCase().includes(filter) || ((p.author?.username)||'').toLowerCase().includes(filter));

      const tbody = document.getElementById('postsTableBody');
      tbody.innerHTML = "";
      filtered.forEach((p, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${p.title}</td>
          <td>${p.author?.username || '-'}</td>
          <td>${p.isPublished ? 'published' : 'draft'}</td>
          <td>${new Date(p.createdAt).toLocaleDateString()}</td>
          <td>
            <button class="btn btn-sm btn-secondary me-1" onclick="togglePublish('${p._id}', ${!p.isPublished})">${p.isPublished ? 'Unpublish' : 'Publish'}</button>
            <button class="btn btn-sm btn-danger" onclick="deletePost('${p._id}')">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function deleteUser(id) {
      if (!confirm("Delete user?")) return;
      const token = localStorage.getItem('adminToken');
      await fetch(`http://localhost:5000/api/admin/manage/users/${id}`, { method: 'DELETE', headers: { Authorization: `Bearer ${token}` } });
      loadUsers();
    }

    async function deletePost(id) {
      if (!confirm("Delete post?")) return;
      const token = localStorage.getItem('adminToken');
      await fetch(`http://localhost:5000/api/admin/manage/posts/${id}`, { method: 'DELETE', headers: { Authorization: `Bearer ${token}` } });
      loadPosts();
    }

    async function togglePublish(id, isPublished) {
      const token = localStorage.getItem('adminToken');
      await fetch(`http://localhost:5000/api/admin/manage/posts/${id}/publish`, { method: 'PATCH', headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` }, body: JSON.stringify({ isPublished }) });
      loadPosts();
    }

    function logout() {
      localStorage.removeItem('isAdminLoggedIn');
      window.location.href = 'admin-login.html';
    }

    // init
    if (!localStorage.getItem('adminToken')) {
      window.location.href = 'admin-login.html';
    }
    showSection('users');
    loadSummary();
    loadUsers();
    loadPosts();
  </script>
</body>
</html>
